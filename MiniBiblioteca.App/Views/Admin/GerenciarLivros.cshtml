@{
    ViewData["Title"] = "Gerenciar Livros";
}

<div class="row mb-4">
    <div class="col-md-12">
        <h2><i class="fas fa-book"></i> Gerenciar Livros</h2>
        <hr />
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-12">
        <button class="btn btn-primary" onclick="abrirModalNovo()">
            <i class="fas fa-plus"></i> Adicionar Novo Livro
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="tableLivros" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Título</th>
                                <th>Autor</th>
                                <th>Categoria</th>
                                <th>Qtd Total</th>
                                <th>Qtd Disponível</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Adicionar/Editar Livro -->
<div class="modal fade" id="modalLivro" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLivroTitle">Adicionar Livro</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formLivro">
                    <input type="hidden" id="livroId">

                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="titulo" class="form-label">Título *</label>
                                <input type="text" class="form-control" id="titulo" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="autor" class="form-label">Autor *</label>
                                <input type="text" class="form-control" id="autor" required>
                            </div>
                        </div>

                    </div>

                    <div class="row">

                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="categoria" class="form-label">Categoria</label>
                                <input type="text" class="form-control" id="categoria">
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="quantidadeTotal" class="form-label">Quantidade Total *</label>
                                <input type="number" class="form-control" id="quantidadeTotal" min="0" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="descricao" class="form-label">Descrição</label>
                        <textarea class="form-control" id="descricao" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="imagemCapa" class="form-label">URL da Imagem da Capa</label>
                        <input type="text" class="form-control" id="imagemCapa" placeholder="https://exemplo.com/imagem.jpg">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarLivro()">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let tableLivros;
        let modal;
        let isEditMode = false;

        $(document).ready(function() {
            modal = new bootstrap.Modal(document.getElementById('modalLivro'));
            carregarLivros();
        });

        function carregarLivros() {
            $.ajax({
                url: '@Url.Action("GetTodosLivros", "Admin")',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        renderizarTabela(response.data);
                    }
                },
                error: function() {
                    Swal.fire('Erro', 'Erro ao carregar livros', 'error');
                }
            });
        }

        function renderizarTabela(livros) {
            if (tableLivros) {
                tableLivros.destroy();
            }

            const tbody = $('#tableLivros tbody');
            tbody.empty();

            livros.forEach(function(livro) {
                debugger;
                const statusBadge = livro.ativo
                    ? '<span class="badge bg-success">Ativo</span>'
                    : '<span class="badge bg-danger">Inativo</span>';

                const row = `
                    <tr>
                        <td>${livro.idLivro}</td>
                        <td>${livro.titulo}</td>
                        <td>${livro.autor}</td>
                        <td>${livro.categoria || 'N/A'}</td>
                        <td>${livro.quantidadeTotal}</td>
                        <td>${livro.quantidadeDisponivel}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editarLivro(${livro.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="removerLivro(${livro.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });

            tableLivros = $('#tableLivros').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json'
                },
                order: [[0, 'desc']]
            });
        }

        function abrirModalNovo() {
            isEditMode = false;
            $('#modalLivroTitle').text('Adicionar Livro');
            $('#formLivro')[0].reset();
            $('#livroId').val('');
            modal.show();
        }

        function editarLivro(id) {
            isEditMode = true;
            $('#modalLivroTitle').text('Editar Livro');

            $.ajax({
                url: '@Url.Action("GetTodosLivros", "Admin")',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        const livro = response.data.find(l => l.id === id);
                        if (livro) {
                            $('#livroId').val(livro.id);
                            $('#titulo').val(livro.titulo);
                            $('#autor').val(livro.autor);
                            $('#categoria').val(livro.categoria);
                            $('#quantidadeTotal').val(livro.quantidadeTotal);
                            $('#descricao').val(livro.descricao);
                            $('#imagemCapa').val(livro.imagemCapa);
                            modal.show();
                        }
                    }
                }
            });
        }

        function salvarLivro() {
            const livro = {
                id: $('#livroId').val() ? parseInt($('#livroId').val()) : 0,
                titulo: $('#titulo').val(),
                autor: $('#autor').val(),
                categoria: $('#categoria').val(),
                quantidadeTotal: parseInt($('#quantidadeTotal').val()),
                descricao: $('#descricao').val(),
                imagemCapa: $('#imagemCapa').val()
            };

            const url = isEditMode
                ? '@Url.Action("AtualizarLivro", "Admin")'
                : '@Url.Action("AdicionarLivro", "Admin")';

            const method = isEditMode ? 'PUT' : 'POST';

            $.ajax({
                url: url,
                type: method,
                contentType: 'application/json',
                data: JSON.stringify(livro),
                success: function(response) {
                    if (response.success) {
                        Swal.fire('Sucesso!', response.message, 'success');
                        modal.hide();
                        carregarLivros();
                    } else {
                        Swal.fire('Erro', response.message, 'error');
                    }
                },
                error: function() {
                    Swal.fire('Erro', 'Erro ao salvar livro', 'error');
                }
            });
        }

        function removerLivro(id) {
            Swal.fire({
                title: 'Tem certeza?',
                text: 'O livro será desativado',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sim, remover',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("RemoverLivro", "Admin")/' + id,
                        type: 'DELETE',
                        success: function(response) {
                            if (response.success) {
                                Swal.fire('Removido!', response.message, 'success');
                                carregarLivros();
                            } else {
                                Swal.fire('Erro', response.message, 'error');
                            }
                        },
                        error: function() {
                            Swal.fire('Erro', 'Erro ao remover livro', 'error');
                        }
                    });
                }
            });
        }
    </script>
}